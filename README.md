# Тестовое задание для отбора на Avito Backend Bootcamp
## Сервис домов

[![CI](https://github.com/AleBal-A/avito-tech-backend-bootcamp-assignment-2024/actions/workflows/ci.yaml/badge.svg)](https://github.com/AleBal-A/avito-tech-backend-bootcamp-assignment-2024/actions/workflows/ci.yaml)
[![codecov](https://codecov.io/gh/AleBal-A/avito-tech-backend-bootcamp-assignment-2024/graph/badge.svg?token=Q1UMC1Z972)](https://codecov.io/gh/AleBal-A/avito-tech-backend-bootcamp-assignment-2024)

## Описание

Данный проект является тестовым заданием для отбора на Avito Backend Bootcamp. Это backend-сервис для работы с каталогом домов на Авито. Сервис позволяет пользователям продавать квартиры, регистрироваться, авторизоваться и модерировать объявления

## Функционал сервиса

### Авторизация пользователей
- **/dummyLogin** — Позволяет получить JWT токен с уровнем доступа (client или moderator), который используется для авторизации во всех остальных эндпоинтах требующих авторизации.

### Регистрация и авторизация по почте и паролю
- **/register** — Регистрация нового пользователя с типом (client или moderator) Возвращает id пользователя.
- **/login** — Авторизация пользователя по ID и паролю, возвращает JWT токен с уровнем доступа.

### Управление недвижимостью
- **/house/create** — Создание дома (только для модераторов).
- **/flat/create** — Создание квартиры (доступно всем авторизованным пользователям).
- **/flat/update** — Обновление статуса модерации квартиры (только для модераторов).
- **/house/{id}** — Получение списка квартир по номеру дома.

## Дополнительные задачи

- **Пользовательская авторизация по методам /register и /login** — Реализована.
- **Настройка CI** — Настроен GitHub Actions для автоматической сборки и тестирования. В `README.md` отображаются бейджи статуса сборки и покрытия кода тестами.
- **Логирование** — В проекте настроен логгер для отслеживания событий и ошибок.

## Установка и запуск

### Предварительные требования

- Docker
- Docker Compose

### Настройка переменных окружения

Перед запуском необходимо задать следующие переменные окружения, данные указаны для примера:

```bash
export DB_USER="myuser"
export DB_PASSWORD="dbpassword"
export JWT_SECRET="secret token"
export CONFIG_PATH="./config/cfg.yaml"
export PORT=8083
```

### Запуск приложения

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/AleBal-A/avito-tech-backend-bootcamp-assignment-2024.git
   cd avito-tech-backend-bootcamp-assignment-2024
   ```

2. Запустите контейнеры с помощью Docker Compose:
   ```bash
   docker-compose up --build
   ```

Это создаст и запустит контейнеры для базы данных, приложения и миграций.

### Использование API

После запуска сервис будет доступен по адресу `http://localhost:${PORT}`

## Проблемы и решения

- **Проблема с подключением к базе данных**: 
  Возникла проблема с подключением к базе данных при запуске контейнеров. Это было решено с помощью настройки `healthcheck` в `docker-compose.yml`, чтобы убедиться, что база данных готова к приему соединений перед запуском сервисов.

- **Регистрация модераторов**:
  В текущей реализации любой неавторизованный пользователь может зарегистрировать модератора и получить токен, открывающий доступ ко всем эндпоинтам. **Как улучшить**: можно использовать инвайт-коды, которые модераторы должны будут указать при регистрации. Инвайт-коды уже должны быть занесены в базу данных для валидации. Альтернативный вариант — создание учетных записей модераторов только через администраторов напрямую в базе данных.

- **Логин через `/login`**:
  В условиях задания API указывает на использование ID и пароля для входа, поэтому я реализовал логин по этим параметрам, хотя в README задания был указан вход по email.

- **Модерация квартир через `/flat/update`**:
  По заданию, конкретную квартиру может проверять только один модератор. Чтобы это реализовать, я добавил к сущности квартиры поле `moderator_id` в базе данных. Когда модератор переводит квартиру в статус «on moderate», ID модератора сохраняется в этом поле. Другие модераторы не могут изменять статус квартиры до завершения работы этого модератора.

- **Производительность запросов по квартирам:**
  Для быстрого получения списка квартир в доме, особенно для пользователей, я добавил индексы на колонки house_id и status в таблице flats. Это существенно ускорило запросы и улучшило масштабируемость системы.

## Стек технологий

- **GoLang**
- **PostgreSQL**
- **Docker & Docker Compose**
- **CI**: GitHub Actions

### Необходимые переменные окружения:

```bash
# ${DB_USER}     "myuser"
# ${DB_PASSWORD} "dbpassword"
# ${JWT_SECRET}  "secret token"
# ${CONFIG_PATH} default: "./config/cfg.yaml"
# ${PORT}        8080 / 8083
```